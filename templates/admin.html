<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot ç®¡ç†å¾Œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .word-tag { display: inline-block; padding: 5px 10px; margin: 3px; border-radius: 15px; background-color: #e9ecef; cursor: pointer; }
        .word-tag:hover { background-color: #ced4da; }
        .word-tag.selected { background-color: #0d6efd; color: white; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">ğŸ¤– æš–æš– ChatBot ç®¡ç†å“¡</a>
        <div class="d-flex gap-2">
            <a href="/admin/review" class="btn btn-outline-warning">ğŸ›¡ï¸ è¨Šæ¯å¯©æ ¸ (Live)</a>
            <a href="/admin/history" class="btn btn-outline-info">ğŸ“œ æ­·å²ç´€éŒ„</a>
        </div>
    </div>
</nav>

<div class="container mb-5">
    
    <div class="card mb-4 shadow-sm border-primary">
        <div class="card-header bg-primary text-white fw-bold">âš™ï¸ ç³»çµ±åƒæ•¸è¨­å®š</div>
        <div class="card-body">
            <form action="/admin/settings/update" method="POST" class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">å¯©æ ¸é é¢ã€Œå‰æƒ…æè¦ã€é¡¯ç¤ºç­†æ•¸</label>
                    <input type="number" name="context_limit" class="form-control" 
                           value="{{ context_limit }}" min="1" required>
                    <div class="form-text">è¨­å®šåœ¨å¯©æ ¸æ™‚ï¼Œé¡¯ç¤ºéå» N å‰‡å°è©±ç´€éŒ„ (ç„¡ä¸Šé™)ã€‚</div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-secondary text-white">ğŸ“Š æ–‡ç« è©é »åˆ†æ (Top 30)</div>
                <div class="card-body">
                    <p class="small text-muted">é»æ“Šä¸‹æ–¹è©å½™å¯ç›´æ¥å¸¶å…¥å³å´è¨“ç·´å€ï¼š</p>
                    <div id="word-cloud">
                        {% for word, count in top_words %}
                        <span class="word-tag" onclick="selectWord('{{ word }}')">{{ word }} <small>({{ count }})</small></span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-info text-white">ğŸ­ èªæ°£ä¿®é£¾èªè¨­å®š</div>
                <div class="card-body">
                    <form action="/admin/modifier/add" method="POST" class="mb-3">
                        <div class="input-group mb-2">
                            <select name="category" class="form-select" required>
                                <option value="support">æ”¯æŒ/åŒç† (Support)</option>
                                <option value="crisis">å±æ©Ÿ/å¼•å° (Crisis)</option>
                            </select>
                            <select name="mod_type" class="form-select" required>
                                <option value="prefix">é–‹é ­ (Prefix)</option>
                                <option value="suffix">çµå°¾ (Suffix)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <input type="text" name="content" class="form-control" placeholder="è¼¸å…¥ä¿®é£¾èª..." required>
                            <button class="btn btn-primary" type="submit">æ–°å¢</button>
                        </div>
                    </form>
                    
                    <ul class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;">
                        {% for mod in modifiers %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <span class="badge bg-light text-dark border">{{ mod.category }}</span>
                                <span class="badge bg-secondary">{{ mod.mod_type }}</span>
                                {{ mod.content }}
                            </span>
                            <form action="/admin/modifier/delete" method="POST" class="d-inline">
                                <input type="hidden" name="mod_id" value="{{ mod.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger py-0">x</button>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">ğŸ§  æ©Ÿå™¨äººæ„åœ–è¨“ç·´ (Intent Training)</div>
                <div class="card-body">
                    <form action="/admin/submit" method="POST">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">å·²é¸é—œéµå­— (Keywords)</label>
                            <div id="selected-words-container" class="border p-2 rounded bg-white" style="min-height: 50px;">
                                <span class="text-muted small ms-2">è«‹å¾å·¦å´é»æ“Šè©å½™...</span>
                            </div>
                            <div id="hidden-inputs"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">æ“ä½œæ¨¡å¼</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="mode-new" value="new" checked onclick="toggleMode()">
                                <label class="form-check-label" for="mode-new">å»ºç«‹æ–°æ„åœ– (New Category)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="mode-existing" value="existing" onclick="toggleMode()">
                                <label class="form-check-label" for="mode-existing">æ›´æ–°ç¾æœ‰æ„åœ– (Update Existing)</label>
                            </div>
                        </div>

                        <div id="new-intent-block">
                            <div class="row mb-2">
                                <div class="col">
                                    <input type="text" name="new_category_name" class="form-control" placeholder="è¼¸å…¥é¡åˆ¥åç¨± (ä¾‹: å¿ƒæƒ…ä¸å¥½)" >
                                </div>
                                <div class="col">
                                    <select name="danger_level" class="form-select">
                                        <option value="0">ğŸŸ¢ å®‰å…¨ (Level 0)</option>
                                        <option value="1">ğŸ”µ è¼•å¾® (Level 1)</option>
                                        <option value="2">ğŸŸ¡ æ³¨æ„ (Level 2)</option>
                                        <option value="3">ğŸŸ  è­¦ç¤º (Level 3)</option>
                                        <option value="4">ğŸ”´ å±éšª (Level 4)</option>
                                        <option value="5">â˜ ï¸ æ¥µå± (Level 5)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-2">
                                <select name="action_code" class="form-select">
                                    <option value="NONE">ç´”æ–‡å­—å›è¦† (NONE)</option>
                                    <option value="SHOW_CRISIS_MENU">é¡¯ç¤ºæ±‚åŠ©é¸å–® (CRISIS)</option>
                                    <option value="SHOW_MAIN_MENU">é¡¯ç¤ºä¸»é¸å–® (MAIN)</option>
                                </select>
                            </div>
                            <textarea name="response_text" class="form-control" rows="3" placeholder="è¼¸å…¥æ©Ÿå™¨äººå›è¦†å…§å®¹..."></textarea>
                        </div>

                        <div id="existing-intent-block" style="display: none;">
                            <select name="category_id" class="form-select">
                                <option value="" disabled selected>é¸æ“‡è¦æ›´æ–°çš„æ„åœ–...</option>
                                {% for intent in intents %}
                                <option value="{{ intent.id }}">{{ intent.category }} ({{ intent.keywords|join(', ') }})</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">é¸æ“‡æ„åœ–å¾Œï¼Œä¸Šæ–¹é¸å–çš„é—œéµå­—å°‡æœƒã€Œè¿½åŠ ã€åˆ°è©²æ„åœ–ä¸­ã€‚</div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mt-3">é€å‡ºè¨“ç·´</button>
                    </form>
                </div>
            </div>

            <div class="mt-4">
                <h5>ğŸ“‚ è³‡æ–™åº«å…§å®¹ç¸½è¦½</h5>
                <table class="table table-hover table-bordered bg-white">
                    <thead>
                        <tr>
                            <th>é¡åˆ¥</th>
                            <th>é—œéµå­—</th>
                            <th>å›è¦†å…§å®¹</th>
                            <th>å±éšªåº¦</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for intent in intents %}
                        <tr>
                            <td>{{ intent.category }}</td>
                            <td>
                                {% for k in intent.keywords %}
                                <span class="badge bg-secondary">{{ k }}</span>
                                {% endfor %}
                            </td>
                            <td>{{ intent.response[:30] }}...</td>
                            <td>{{ intent.danger }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedWords = new Set();
    function selectWord(word) {
        if (selectedWords.has(word)) return;
        selectedWords.add(word);
        renderSelectedWords();
    }
    function removeWord(word) {
        selectedWords.delete(word);
        renderSelectedWords();
    }
    function renderSelectedWords() {
        const container = document.getElementById('selected-words-container');
        const hiddenDiv = document.getElementById('hidden-inputs');
        container.innerHTML = '';
        hiddenDiv.innerHTML = '';
        if (selectedWords.size === 0) {
            container.innerHTML = '<span class="text-muted small ms-2">è«‹å¾å·¦å´é»æ“Šè©å½™...</span>';
            return;
        }
        selectedWords.forEach(word => {
            const tag = document.createElement('span');
            tag.className = 'badge bg-primary me-1 mb-1';
            tag.style.cursor = 'pointer';
            tag.innerHTML = `${word} &times;`;
            tag.onclick = () => removeWord(word);
            container.appendChild(tag);
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_words';
            input.value = word;
            hiddenDiv.appendChild(input);
        });
    }
    function toggleMode() {
        const isNew = document.getElementById('mode-new').checked;
        document.getElementById('new-intent-block').style.display = isNew ? 'block' : 'none';
        document.getElementById('existing-intent-block').style.display = isNew ? 'none' : 'block';
    }
</script>

</body>
</html>