{% if pending_msgs %}
    {# 1. ä¾ç…§ user_id é€²è¡Œåˆ†çµ„æ’åº #}
    {% for user_id, user_msgs in pending_msgs | sort(attribute='user_id') | groupby('user_id') %}
    
    {# å–å‡ºç¬¬ä¸€å‰‡è¨Šæ¯ä»¥ç²å–å…±ç”¨çš„æ­·å²ç´€éŒ„ (å› ç‚ºåŒä¸€äººçš„æ­·å²ç´€éŒ„æ˜¯ä¸€æ¨£çš„) #}
    {% set first_msg = user_msgs[0] %}

    <div class="card mb-5 shadow border-0 overflow-hidden border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">ğŸ‘¤ User: {{ user_id }}</h5>
            <span class="badge bg-white text-primary">{{ user_msgs|length }} å‰‡å¾…å¯©</span>
        </div>

        <div class="row g-0">
            <div class="col-md-4 border-end bg-white">
                <div class="p-3 sticky-top" style="top: 0; max-height: 80vh; overflow-y: auto;">
                    <h6 class="fw-bold text-muted border-bottom pb-2 mb-3">ğŸ“œ æ­·å²è¨Šæ¯ (å‹¾é¸åŠ å…¥ AI åƒè€ƒ)</h6>
                    
                    {% if first_msg.history_context %}
                        {% for h_msg in first_msg.history_context %}
                        <div class="mb-3 border-bottom pb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="badge {% if h_msg.role == 'bot' %}bg-info{% else %}bg-secondary{% endif %}">
                                    {{ h_msg.role }}
                                </span>
                                <small class="text-muted" style="font-size: 0.7em;">{{ h_msg.created_at }}</small>
                            </div>
                            <div class="text-dark small mb-1">{{ h_msg.message }}</div>
                            <div class="d-flex flex-wrap gap-1">
                                {% for word in h_msg.segmented_words %}
                                <input type="checkbox" id="h_{{ user_id }}_{{ h_msg.id }}_{{ loop.index }}" 
                                       name="history_kws_user_{{ user_id }}" value="{{ word }}" class="word-checkbox">
                                <label for="h_{{ user_id }}_{{ h_msg.id }}_{{ loop.index }}" class="word-label small text-muted" style="font-size: 0.75rem; padding: 2px 8px;">{{ word }}</label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-muted py-4">ç„¡æ­·å²ç´€éŒ„</p>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-8 bg-light">
                <div class="p-3">
                    <h6 class="fw-bold text-danger mb-3">ğŸš¨ å¾…å¯©è¨Šæ¯åˆ—è¡¨</h6>
                    
                    {% for msg in user_msgs %}
                    <div class="card mb-3 shadow-sm border-0">
                        <div class="card-body">
                            <form action="/admin/process_reply" method="POST">
                                <input type="hidden" name="msg_id" value="{{ msg.id }}">
                                <input type="hidden" name="user_id" value="{{ msg.user_id }}">

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-warning text-dark">è¨Šæ¯ #{{ msg.id }}</span>
                                    <span class="text-muted small">{{ msg.created_at }}</span>
                                </div>

                                <div class="p-3 mb-3 bg-light rounded border-start border-4 border-danger">
                                    <p class="mb-0 fw-bold text-dark">{{ msg.user_message }}</p>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-primary">ç•¶å‰é—œéµå­—ï¼š</label>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for word in msg.segmented_words %}
                                        <input type="checkbox" id="w_{{ msg.id }}_{{ loop.index }}" 
                                               name="selected_keywords" value="{{ word }}" class="word-checkbox">
                                        <label for="w_{{ msg.id }}_{{ loop.index }}" class="word-label">{{ word }}</label>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="bg-light p-3 rounded border">
                                    <div class="row g-3">
                                        <div class="col-md-5 border-end">
                                            <label class="small text-muted mb-1">å±éšªè©•ç´šï¼š</label>
                                            <select name="danger_level" class="form-select form-select-sm mb-2">
                                                <option value="0" selected>ğŸŸ¢ å®‰å…¨ (0)</option>
                                                <option value="1">ğŸ”µ è¼•å¾® (1)</option>
                                                <option value="2">ğŸŸ¡ æ³¨æ„ (2)</option>
                                                <option value="3">ğŸŸ  è­¦ç¤º (3)</option>
                                                <option value="4">ğŸ”´ å±éšª (4)</option>
                                                <option value="5">â˜ ï¸ æ¥µå± (5)</option>
                                            </select>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="save_to_db" id="save_{{ msg.id }}" checked>
                                                <label class="form-check-label small" for="save_{{ msg.id }}">å­˜å…¥ DB</label>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-7">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <label class="small fw-bold">å›è¦†å…§å®¹</label>
                                                <button class="btn btn-sm btn-outline-primary py-0" type="button" 
                                                        onclick="generateAI_WithHistory('{{ msg.id }}', '{{ user_id }}')">
                                                    ğŸ¤– ç”Ÿæˆå»ºè­°
                                                </button>
                                            </div>
                                            <textarea name="final_response" id="response_{{ msg.id }}" class="form-control mb-2" rows="3" required></textarea>
                                            <button type="submit" class="btn btn-success btn-sm w-100">ç™¼é€å›è¦†</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                    
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="text-center py-5 bg-white rounded shadow-sm">
        <h4 class="text-muted">ğŸ‰ ç›®å‰æ²’æœ‰å¾…å¯©æ ¸è¨Šæ¯</h4>
        <p class="text-muted">è‹¥æœ‰æ–°è¨Šæ¯ï¼Œç•«é¢å°‡è‡ªå‹•æ›´æ–°ã€‚</p>
    </div>
{% endif %}