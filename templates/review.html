<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨Šæ¯å¯©æ ¸ (Live)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .word-checkbox { display: none; }
        .word-label { cursor: pointer; padding: 4px 10px; border: 1px solid #ced4da; border-radius: 20px; font-size: 0.9em; background: #fff; transition: 0.2s; }
        .word-checkbox:checked + .word-label { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4" style="max-width: 800px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">ğŸ›¡ï¸ è¨Šæ¯å¯©æ ¸ <span class="badge bg-danger fs-6 blink">Live</span></h3>
        <a href="/admin" class="btn btn-outline-secondary btn-sm">å›ä¸»æ§å°</a>
    </div>

    <div id="live-review-content">
        {% include 'review_content.html' %}
    </div>
</div>

<script>
    // 1. AI ç”Ÿæˆ
    async function generateAI(msgId) {
        const checkboxes = document.querySelectorAll(`input[id^="w_${msgId}_"]:checked`);
        let keywords = [];
        checkboxes.forEach((cb) => keywords.push(cb.value));
        if (keywords.length === 0) { alert("è«‹å…ˆå‹¾é¸é—œéµå­—"); return; }
        
        const textArea = document.getElementById(`response_${msgId}`);
        textArea.value = "ğŸ”„ AI ç”Ÿæˆä¸­...";
        try {
            const res = await fetch('/admin/api/generate', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ keywords: keywords })
            });
            const data = await res.json();
            textArea.value = data.suggestion;
        } catch { textArea.value = "é€£ç·šå¤±æ•—"; }
    }

    // 2. è‡ªå‹•æ›´æ–° (é˜²æ­¢å¿«å–ç‰ˆ)
    function autoRefresh() {
        // é˜²æ­¢åœ¨æ“ä½œæ™‚æ›´æ–°å¹²æ“¾
        const isBusy = document.querySelectorAll('input[type="checkbox"]:checked').length > 0 || 
                       (document.activeElement && document.activeElement.tagName === 'TEXTAREA');
        
        if (isBusy) {
            console.log("ä½¿ç”¨è€…æ“ä½œä¸­ï¼Œæš«åœæ›´æ–°...");
            return;
        }

        // ğŸ”¥ é—œéµä¿®æ­£ï¼šåŠ ä¸Š new Date().getTime() é˜²æ­¢å¿«å–
        fetch('/admin/api/review_content?t=' + new Date().getTime())
            .then(r => r.text())
            .then(html => {
                const container = document.getElementById('live-review-content');
                if (container) container.innerHTML = html;
            })
            .catch(e => console.error("æ›´æ–°å¤±æ•—:", e));
    }

    // æ¯ 3 ç§’æª¢æŸ¥ä¸€æ¬¡
    setInterval(autoRefresh, 3000);
</script>
</body>
</html>