<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< HEAD
    <title>è¨Šæ¯å¯©æ ¸ (Live)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .word-checkbox { display: none; }
        .word-label { cursor: pointer; padding: 4px 10px; border: 1px solid #ced4da; border-radius: 20px; font-size: 0.9em; background: #fff; transition: 0.2s; }
        .word-checkbox:checked + .word-label { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
=======
    <title>è¨Šæ¯å¯©æ ¸èˆ‡å»è­˜åˆ¥åŒ–</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* éš±è—åŸæœ¬çš„ checkboxï¼Œæ”¹ç”¨ label æ¨£å¼ä¾†é¡¯ç¤º */
        .word-checkbox { display: none; }
        
        .word-label {
            cursor: pointer;
            padding: 6px 12px;
            margin: 4px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            display: inline-block;
            transition: all 0.2s;
            background-color: #fff;
        }

        /* ç•¶ checkbox è¢«å‹¾é¸æ™‚ï¼Œlabel è®Šè‰² */
        .word-checkbox:checked + .word-label {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
        }

        .original-msg {
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 10px;
            color: #555;
            font-size: 0.95rem;
        }
>>>>>>> 023a5a7f251de2f2f52a56b38e048cf831210f97
    </style>
</head>
<body class="bg-light">

<<<<<<< HEAD
<div class="container py-4" style="max-width: 800px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">ğŸ›¡ï¸ è¨Šæ¯å¯©æ ¸ <span class="badge bg-danger fs-6 blink">Live</span></h3>
        <a href="/admin" class="btn btn-outline-secondary btn-sm">å›ä¸»æ§å°</a>
    </div>

    <div id="live-review-content">
        {% include 'review_content.html' %}
    </div>
</div>

<script>
    // 1. AI ç”Ÿæˆ
    async function generateAI(msgId) {
        const checkboxes = document.querySelectorAll(`input[id^="w_${msgId}_"]:checked`);
        let keywords = [];
        checkboxes.forEach((cb) => keywords.push(cb.value));
        if (keywords.length === 0) { alert("è«‹å…ˆå‹¾é¸é—œéµå­—"); return; }
        
        const textArea = document.getElementById(`response_${msgId}`);
        textArea.value = "ğŸ”„ AI ç”Ÿæˆä¸­...";
        try {
            const res = await fetch('/admin/api/generate', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ keywords: keywords })
            });
            const data = await res.json();
            textArea.value = data.suggestion;
        } catch { textArea.value = "é€£ç·šå¤±æ•—"; }
    }

    // 2. è‡ªå‹•æ›´æ–° (é˜²æ­¢å¿«å–ç‰ˆ)
    function autoRefresh() {
        // é˜²æ­¢åœ¨æ“ä½œæ™‚æ›´æ–°å¹²æ“¾
        const isBusy = document.querySelectorAll('input[type="checkbox"]:checked').length > 0 || 
                       (document.activeElement && document.activeElement.tagName === 'TEXTAREA');
        
        if (isBusy) {
            console.log("ä½¿ç”¨è€…æ“ä½œä¸­ï¼Œæš«åœæ›´æ–°...");
            return;
        }

        // ğŸ”¥ é—œéµä¿®æ­£ï¼šåŠ ä¸Š new Date().getTime() é˜²æ­¢å¿«å–
        fetch('/admin/api/review_content?t=' + new Date().getTime())
            .then(r => r.text())
            .then(html => {
                const container = document.getElementById('live-review-content');
                if (container) container.innerHTML = html;
            })
            .catch(e => console.error("æ›´æ–°å¤±æ•—:", e));
    }

    // æ¯ 3 ç§’æª¢æŸ¥ä¸€æ¬¡
    setInterval(autoRefresh, 3000);
</script>
=======
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ›¡ï¸ è¨Šæ¯å¯©æ ¸ (Human-in-the-loop)</h2>
        <a href="/admin" class="btn btn-outline-secondary">å›åˆ°ä¸»æ§å°</a>
    </div>

    {% if pending_msgs %}
        {% for msg in pending_msgs %}
        <div class="card mb-5 shadow border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <span class="badge bg-warning text-dark">å¾…è™•ç†</span>
                <small class="text-muted">æ¥æ”¶æ™‚é–“: {{ msg.created_at }}</small>
            </div>
            <div class="card-body">
                
                <div class="mb-4">
                    <label class="form-label fw-bold">åŸå§‹è¨Šæ¯ (å«å€‹è³‡)</label>
                    <div class="original-msg">{{ msg.user_message }}</div>
                </div>

                <form action="/admin/process_reply" method="POST">
                    <input type="hidden" name="msg_id" value="{{ msg.id }}">
                    <input type="hidden" name="user_id" value="{{ msg.user_id }}">

                    <div class="mb-4 p-3 border rounded bg-white">
                        <label class="form-label fw-bold text-primary">Step 1: å‹¾é¸è¦ä¿ç•™çš„ã€Œç‰¹å¾µè©ã€(å»è­˜åˆ¥åŒ–)</label>
                        <p class="small text-muted mb-2">è«‹åªå‹¾é¸äº‹ä»¶é—œéµå­—ï¼ˆå¦‚ï¼šå¿ƒæƒ…ã€æ³•å¾‹ã€ç³¾ç´›ï¼‰ï¼Œ<span class="text-danger">ä¸è¦å‹¾é¸äººåã€åœ°é»æˆ–å…·é«”ç‰¹å¾µ</span>ã€‚</p>
                        
                        <div class="d-flex flex-wrap">
                            {% for word in msg.segmented_words %}
                            <div>
                                <input type="checkbox" id="w_{{ msg.id }}_{{ loop.index }}" 
                                       name="selected_keywords" value="{{ word }}" class="word-checkbox">
                                <label for="w_{{ msg.id }}_{{ loop.index }}" class="word-label">{{ word }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Step 2: ç”¢ç”Ÿå›è¦†è‰ç¨¿</label>
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-outline-primary btn-sm" type="button" onclick="generateAI('{{ msg.id }}')">
                                ğŸ¤– æ ¹æ“šå‹¾é¸è©å½™ç”Ÿæˆå»ºè­°
                            </button>
                        </div>
                        <textarea name="final_response" id="response_{{ msg.id }}" class="form-control" rows="5" placeholder="è«‹å…ˆå‹¾é¸ä¸Šæ–¹è©å½™ï¼Œå†é»æ“Šç”Ÿæˆï¼Œæˆ–ç›´æ¥åœ¨æ­¤è¼¸å…¥å›è¦†..." required></textarea>
                    </div>

                    <div class="form-check mb-3 p-3 bg-light rounded">
                        <input class="form-check-input" type="checkbox" name="save_to_db" id="save_{{ msg.id }}" checked>
                        <label class="form-check-label fw-bold" for="save_{{ msg.id }}">
                            å°‡æ­¤æ¡ˆä¾‹å­˜å…¥è³‡æ–™åº« (Learn from this)
                        </label>
                        <div class="small text-muted">
                            å‹¾é¸å¾Œï¼Œç³»çµ±æœƒè¨˜éŒ„ã€Œå‹¾é¸çš„é—œéµå­—ã€å°æ‡‰ã€Œé€™å‰‡å›è¦†ã€ã€‚ä¸‹æ¬¡è‹¥æœ‰é¡ä¼¼é—œéµå­—ï¼Œæ©Ÿå™¨äººå°±èƒ½è‡ªå‹•å›ç­”ã€‚
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 py-2 fw-bold">ç¢ºèªç™¼é€ (Push Message)</button>
                </form>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <h4 class="text-muted">ğŸ‰ ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è¨Šæ¯</h4>
            <p>å»å–æ¯å’–å•¡å§ï¼</p>
        </div>
    {% endif %}
</div>

<script>
async function generateAI(msgId) {
    // 1. æŠ“å–è©²å‰‡è¨Šæ¯æ‰€æœ‰è¢«å‹¾é¸çš„ checkbox
    const checkboxes = document.querySelectorAll(`input[id^="w_${msgId}_"]:checked`);
    let keywords = [];
    checkboxes.forEach((cb) => keywords.push(cb.value));

    if (keywords.length === 0) {
        alert("âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€å€‹é—œéµå­—ï¼ŒAI æ‰çŸ¥é“è¦é‡å°ä»€éº¼ä¸»é¡Œç”Ÿæˆï¼");
        return;
    }

    const textArea = document.getElementById(`response_${msgId}`);
    const originalText = textArea.value;
    textArea.value = "ğŸ”„ AI æ­£åœ¨æ€è€ƒä¸­...";

    try {
        // 2. å‘¼å«å¾Œç«¯ API
        const response = await fetch('/admin/api/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ keywords: keywords })
        });
        const data = await response.json();
        
        // 3. å¡«å…¥çµæœ
        textArea.value = data.suggestion;
    } catch (e) {
        console.error(e);
        textArea.value = originalText; // æ¢å¾©åŸæœ¬å…§å®¹
        alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
    }
}
</script>

>>>>>>> 023a5a7f251de2f2f52a56b38e048cf831210f97
</body>
</html>